<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»Šæ—¥ã®å¾©ç¿’ãƒ¡ãƒ¢</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        /* Custom scrollbar for messages div */
        #messages::-webkit-scrollbar {
            width: 8px;
        }
        #messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        #messages::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        #messages::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Fade-in animation for messages */
        .message-enter {
            opacity: 0;
            transform: translateY(10px);
        }
        .message-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }

        /* Fake screen styling - REMOVED */
        /* #fake-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #e0e0e0;
            color: #555;
            justify-content: center;
            align-items: center;
            font-size: 2em;
            flex-direction: column;
            z-index: 1000;
            text-align: center;
        }
        #fake-screen.active {
            display: flex;
        } */
    </style>
</head>
<body>
    <div id="app-container" class="bg-white p-6 md:p-8 rounded-lg shadow-xl w-full max-w-md mx-4 sm:mx-auto border border-gray-200">
        <h1 class="text-2xl md:text-3xl font-bold text-center mb-4 text-blue-700">ä»Šæ—¥ã®å¾©ç¿’ãƒ¡ãƒ¢</h1>
        <p class="text-sm text-gray-600 text-center mb-6">â€» ã“ã®ãƒ„ãƒ¼ãƒ«ã¯å­¦ç¿’å†…å®¹ã®æŒ¯ã‚Šè¿”ã‚Šã‚„ç–‘å•ç‚¹ã®å…±æœ‰ã«ã”åˆ©ç”¨ãã ã•ã„ã€‚</p>

        <div id="loading-indicator" class="text-center text-gray-500 mb-4" style="display: none;">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-2"></div>
            <p>èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>

        <div id="user-info" class="text-sm text-gray-500 mb-4 hidden">
            ã‚ãªãŸã®ID: <span id="user-id-display" class="font-mono text-blue-600 break-all"></span>
        </div>

        <!-- Nickname setting section -->
        <div class="mb-4 p-3 border border-gray-200 rounded-md bg-gray-50">
            <label for="nicknameInput" class="block text-sm font-medium text-gray-700 mb-2">ã‚ãªãŸã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ :</label>
            <div class="flex gap-2">
                <input type="text" id="nicknameInput" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›"
                       class="flex-grow p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-400 text-sm">
                <button id="setNicknameBtn"
                        class="px-3 py-2 bg-green-500 text-white font-semibold rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400 transition-colors duration-200 shadow-sm text-sm">
                    è¨­å®š
                </button>
            </div>
            <p id="currentNicknameDisplay" class="text-xs text-gray-500 mt-2">ç¾åœ¨ã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ : <span class="font-bold text-gray-700"></span></p>
        </div>

        <div id="messages" class="border border-gray-300 p-4 h-96 overflow-y-auto mb-4 rounded-md bg-gray-50 scroll-smooth">
            <!-- Messages will be displayed here -->
        </div>

        <div class="flex justify-end mb-4">
            <button id="clearChatBtn" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 transition-colors duration-200 shadow-md text-sm">
                ãƒãƒ£ãƒƒãƒˆã‚’ã‚¯ãƒªã‚¢
            </button>
        </div>

        <div id="message-input-container" class="flex gap-3">
            <input type="text" id="messageInput" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›..."
                   class="flex-grow p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
            <button id="sendMessageBtn"
                    class="px-5 py-3 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-colors duration-200 shadow-md">
                é€ä¿¡
            </button>
        </div>
    </div>

    <!-- ãƒ•ã‚§ã‚¤ã‚¯ç”»é¢ - REMOVED -->
    <!-- <div id="fake-screen" class="active:flex">
        <p class="text-4xl font-bold text-gray-700 mb-4">ç¾åœ¨ã®å­¦ç¿’çŠ¶æ³</p>
        <p class="text-xl text-gray-600">ï¼ˆæˆæ¥­å†…å®¹ã«é–¢ã™ã‚‹çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚„ã€ç„¡å®³ãªå­¦ç¿’ã‚¢ãƒ‰ãƒã‚¤ã‚¹ãªã©ã‚’ã“ã“ã«è¡¨ç¤ºï¼‰</p>
        <p class="text-sm text-gray-500 mt-8">[Ctrl + H ã§æˆ»ã‚‹]</p>
    </div> -->

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, getDocs, writeBatch, doc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        // Firebase è¨­å®š - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰æä¾›ã•ã‚ŒãŸè¨­å®šã‚’ä½¿ç”¨
        const firebaseConfig = {
            apiKey: "AIzaSyDggfvHZMmox-_2N8lT9UjzmJTH36jSNy0",
            authDomain: "loiloidiot-mail.firebaseapp.com",
            projectId: "loiloidiot-mail",
            storageBucket: "loiloidiot-mail.firebasestorage.app",
            messagingSenderId: "457273591838",
            appId: "1:457273591838:web:5c30edaf7a908061f9860f",
            measurementId: "G-QX07FG8730"
        };

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ID (Canvasç’°å¢ƒã‹ã‚‰æä¾›ã•ã‚Œã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // FirebaseåˆæœŸåŒ–ãƒˆãƒ¼ã‚¯ãƒ³ (Canvasç’°å¢ƒã‹ã‚‰æä¾›ã•ã‚Œã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°)
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase åˆæœŸåŒ–
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // DOMè¦ç´ ã®å–å¾—
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const clearChatBtn = document.getElementById('clearChatBtn');
        // const fakeScreen = document.getElementById('fake-screen'); // REMOVED
        const appContainer = document.getElementById('app-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        const userIdDisplay = document.getElementById('user-id-display');
        const userInfoDiv = document.getElementById('user-info');
        const nicknameInput = document.getElementById('nicknameInput');
        const setNicknameBtn = document.getElementById('setNicknameBtn');
        const currentNicknameDisplay = document.querySelector('#currentNicknameDisplay span');

        // NGãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ
        const ngWords = ['vpn', 'ãƒ—ãƒ­ã‚­ã‚·', 'è„±å‡º', 'ç›£è¦–', 'ç®¡ç†è€…', 'proxy', 'escape', 'monitor', 'admin'];
        const ngWordReplacement = 'ğŸ™';

        let userNickname = localStorage.getItem('userNickname');
        let currentUserId = null;

        const generateAnonymousNickname = () => {
            const adjectives = ['é™ã‹ãª', 'ç´ æ—©ã„', 'è³¢ã„', 'ç§˜å¯†ã®', 'å‹‡æ•¢ãª', 'è‡ªç”±ãª', 'é™å¯‚ã®', 'è¼ã', 'è¦‹ãˆãªã„', 'æœªæ¥ã®'];
            const nouns = ['å­¦ç¿’è€…', 'æ¢ç©¶è€…', 'æ€ç´¢å®¶', 'è¨˜éŒ²è€…', 'é–‹æ‹“è€…', 'è¦³å¯Ÿè€…', 'æ¡ˆå†…äºº', 'ä¼é”è€…', 'åé›†å®¶', 'çŸ¥è­˜äºº'];
            const randomAdjective = adjectives[Math.floor(Math.random() * adjectives.length)];
            const randomNoun = nouns[Math.floor(Math.random() * nouns.length)];
            const randomNumber = Math.floor(Math.random() * 900) + 100;
            return `${randomAdjective}${randomNoun}${randomNumber}`;
        };

        // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã®åˆæœŸè¨­å®šã¨è¡¨ç¤º
        if (!userNickname) {
            userNickname = generateAnonymousNickname();
            localStorage.setItem('userNickname', userNickname);
        }
        nicknameInput.value = userNickname;
        currentNicknameDisplay.textContent = userNickname;

        // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ è¨­å®šãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        setNicknameBtn.addEventListener('click', () => {
            const newNickname = nicknameInput.value.trim();
            if (newNickname) {
                userNickname = newNickname;
                localStorage.setItem('userNickname', userNickname);
                currentNicknameDisplay.textContent = userNickname;
                displayMessageBox(`ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’ã€Œ${userNickname}ã€ã«è¨­å®šã—ã¾ã—ãŸã€‚`, "ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ è¨­å®š", "blue");
            } else {
                displayMessageBox("ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", "ã‚¨ãƒ©ãƒ¼", "red");
            }
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                userIdDisplay.textContent = currentUserId;
                userInfoDiv.classList.remove('hidden');
                loadingIndicator.style.display = 'none';
                console.log("èªè¨¼æˆåŠŸï¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:", currentUserId);

                const messagesCollectionRef = collection(db, `artifacts/${appId}/public/data/messages`);
                const q = query(messagesCollectionRef, orderBy('timestamp', 'asc'));

                onSnapshot(q, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "added") {
                            const message = change.doc.data();
                            const messageElement = document.createElement('div');
                            messageElement.classList.add('message', 'mb-2', 'p-3', 'rounded-lg', 'break-words', 'relative', 'overflow-hidden');
                            messageElement.classList.add('bg-blue-100', 'text-blue-800', 'shadow-sm', 'message-enter');

                            const timestamp = message.timestamp ? message.timestamp.toDate().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }) : 'é€ä¿¡ä¸­...';
                            
                            messageElement.innerHTML = `
                                <div class="font-semibold text-blue-700">${message.author}</div>
                                <div class="text-gray-900">${message.text}</div>
                                <div class="text-xs text-gray-500 mt-1 text-right">${timestamp}</div>
                            `;
                            messagesDiv.appendChild(messageElement);

                            setTimeout(() => messageElement.classList.add('message-enter-active'), 10);
                            messagesDiv.scrollTop = messagesDiv.scrollHeight;
                        } else if (change.type === "removed") {
                            const removedMessageId = change.doc.id;
                            const messageElements = messagesDiv.children;
                            for (let i = 0; i < messageElements.length; i++) {
                                if (messageElements[i].dataset.docId === removedMessageId) {
                                    messagesDiv.removeChild(messageElements[i]);
                                    break;
                                }
                            }
                        }
                    });
                }, (error) => {
                    console.error("Error getting real-time updates: ", error);
                    displayMessageBox("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", "ã‚¨ãƒ©ãƒ¼", "red");
                });

            } else {
                loadingIndicator.style.display = 'block';
                console.log("èªè¨¼è©¦è¡Œä¸­...");
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ã‚¯ãƒ³ã§èªè¨¼ã‚’è©¦ã¿ã¾ã—ãŸã€‚");
                    } else {
                        await signInAnonymously(auth);
                        console.log("åŒ¿åèªè¨¼ã‚’è©¦ã¿ã¾ã—ãŸã€‚");
                    }
                } catch (error) {
                    console.error("Error during authentication: ", error);
                    displayMessageBox("èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¢ãƒ—ãƒªã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚", "ã‚¨ãƒ©ãƒ¼", "red");
                    loadingIndicator.style.display = 'none';
                }
            }
        });

        sendMessageBtn.addEventListener('click', async () => {
            const messageText = messageInput.value.trim();
            if (messageText && currentUserId) {
                let maskedMessage = messageText;
                ngWords.forEach(word => {
                    const regex = new RegExp(`\\b${word}\\b`, 'gi');
                    maskedMessage = maskedMessage.replace(regex, ngWordReplacement.repeat(word.length));
                });

                try {
                    const messagesCollectionRef = collection(db, `artifacts/${appId}/public/data/messages`);
                    await addDoc(messagesCollectionRef, {
                        author: userNickname,
                        text: maskedMessage,
                        timestamp: serverTimestamp()
                    });
                    messageInput.value = '';
                    console.log("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æˆåŠŸï¼");
                } catch (error) {
                    console.error("Error writing document: ", error);
                    displayMessageBox("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", "ã‚¨ãƒ©ãƒ¼", "red");
                }
            } else if (!currentUserId) {
                displayMessageBox("ã¾ã èªè¨¼ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚", "æ³¨æ„", "yellow");
                console.log("èªè¨¼ãŒå®Œäº†ã—ã¦ã„ãªã„ãŸã‚ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã§ãã¾ã›ã‚“ã€‚");
            }
        });

        clearChatBtn.addEventListener('click', () => {
            displayConfirmBox("æœ¬å½“ã«ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚", "ãƒãƒ£ãƒƒãƒˆã‚¯ãƒªã‚¢ã®ç¢ºèª", "red", async (confirmed) => {
                if (confirmed) {
                    try {
                        const messagesCollectionRef = collection(db, `artifacts/${appId}/public/data/messages`);
                        const querySnapshot = await getDocs(messagesCollectionRef);
                        
                        const batch = writeBatch(db);
                        querySnapshot.docs.forEach((d) => {
                            batch.delete(doc(db, `artifacts/${appId}/public/data/messages`, d.id));
                        });
                        await batch.commit();

                        messagesDiv.innerHTML = ''; 
                        displayMessageBox("ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸã€‚", "å®Œäº†", "blue");
                        console.log("ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸã€‚");
                    } catch (error) {
                        console.error("Error clearing chat: ", error);
                        displayMessageBox("ãƒãƒ£ãƒƒãƒˆã®ã‚¯ãƒªã‚¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", "ã‚¨ãƒ©ãƒ¼", "red");
                    }
                }
            });
        });

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessageBtn.click();
            }
        });

        // Ctrl+Hã®æ©Ÿèƒ½ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚
        /*
        document.addEventListener('keydown', (event) => {
            if (event.ctrlKey && event.key === 'h') {
                event.preventDefault();
                if (fakeScreen.classList.contains('active')) {
                    fakeScreen.classList.remove('active');
                    appContainer.style.display = 'block';
                } else {
                    fakeScreen.classList.add('active');
                    appContainer.style.display = 'none';
                }
            }
        });
        */

        function displayMessageBox(message, title = "é€šçŸ¥", type = "blue") {
            const existingBox = document.getElementById('custom-message-box');
            if (existingBox) existingBox.remove();

            const box = document.createElement('div');
            box.id = 'custom-message-box';
            box.className = `fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50`;
            box.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 border-t-4 ${type === 'red' ? 'border-red-500' : type === 'yellow' ? 'border-yellow-500' : 'border-blue-500'}">
                    <h3 class="text-lg font-bold mb-3 ${type === 'red' ? 'text-red-700' : type === 'yellow' ? 'text-yellow-700' : 'text-blue-700'}">${title}</h3>
                    <p class="text-gray-700 mb-4">${message}</p>
                    <button id="message-box-ok-btn" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400">OK</button>
                </div>
            `;
            document.body.appendChild(box);

            document.getElementById('message-box-ok-btn').addEventListener('click', () => {
                box.remove();
            });
        }

        function displayConfirmBox(message, title = "ç¢ºèª", type = "blue", callback) {
            const existingBox = document.getElementById('custom-confirm-box');
            if (existingBox) existingBox.remove();

            const box = document.createElement('div');
            box.id = 'custom-confirm-box';
            box.className = `fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50`;
            box.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 border-t-4 ${type === 'red' ? 'border-red-500' : type === 'yellow' ? 'border-yellow-500' : 'border-blue-500'}">
                    <h3 class="text-lg font-bold mb-3 ${type === 'red' ? 'text-red-700' : type === 'yellow' ? 'text-yellow-700' : 'text-blue-700'}">${title}</h3>
                    <p class="text-gray-700 mb-4">${message}</p>
                    <div class="flex justify-end gap-3">
                        <button id="confirm-box-cancel-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button id="confirm-box-ok-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400">OK</button>
                    </div>
                </div>
            `;
            document.body.appendChild(box);

            document.getElementById('confirm-box-ok-btn').addEventListener('click', () => {
                box.remove();
                callback(true);
            });

            document.getElementById('confirm-box-cancel-btn').addEventListener('click', () => {
                box.remove();
                callback(false);
            });
        }
    </script>
</body>
</html>
