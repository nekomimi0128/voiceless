<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»Šæ—¥ã®å¾©ç¿’ãƒ¡ãƒ¢</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«ã¨ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            transition: background-color 0.5s ease-in-out, color 0.5s ease-in-out;
        }
        #app-container {
            transition: background-color 0.5s ease-in-out, border-color 0.5s ease-in-out, box-shadow 0.5s ease-in-out;
        }
        .message {
            transition: background-color 0.5s ease-in-out, color 0.5s ease-in-out;
        }
        #messageInput, #nicknameInput {
            transition: background-color 0.5s ease-in-out, border-color 0.5s ease-in-out, color 0.5s ease-in-out;
        }
        .bg-gray-50, .bg-white, .border-gray-200, .border-gray-300 {
            transition: background-color 0.5s ease-in-out, border-color 0.5s ease-in-out;
        }
        .text-gray-600, .text-gray-500, .text-gray-700, .text-blue-700, .text-blue-600, .text-gray-900 {
            transition: color 0.5s ease-in-out;
        }
        /* ãƒœã‚¿ãƒ³ã®ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ */
        button {
            transition: background-color 0.3s ease-in-out, color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }

        /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
        body.dark-mode {
            background-color: #1a202c; /* ãƒ€ãƒ¼ã‚¯ãªèƒŒæ™¯ */
            color: #e2e8f0; /* æ˜ã‚‹ã„æ–‡å­—è‰² */
        }
        body.dark-mode #app-container {
            background-color: #2d3748; /* ãƒ€ãƒ¼ã‚¯ãªã‚³ãƒ³ãƒ†ãƒŠèƒŒæ™¯ */
            border-color: #4a5568;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        body.dark-mode h1 {
            color: #90cdf4; /* æ˜ã‚‹ã„é’ */
        }
        body.dark-mode p.text-gray-600 {
            color: #cbd5e0; /* æ˜ã‚‹ã„ã‚°ãƒ¬ãƒ¼ */
        }
        body.dark-mode #messages {
            background-color: #242d3b; /* ãƒ€ãƒ¼ã‚¯ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢èƒŒæ™¯ */
            border-color: #4a5568;
        }
        body.dark-mode .message {
            background-color: #4a5568; /* ãƒ€ãƒ¼ã‚¯ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸èƒŒæ™¯ */
            color: #e2e8f0; /* æ˜ã‚‹ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ–‡å­—è‰² */
        }
        body.dark-mode .message .font-semibold {
            color: #90cdf4; /* æ˜ã‚‹ã„é’ */
        }
        body.dark-mode .message .text-gray-900 {
            color: #e2e8f0;
        }
        body.dark-mode .message .text-gray-500 {
            color: #a0aec0;
        }
        body.dark-mode .message .text-gray-600 {
            color: #a0aec0;
        }
        body.dark-mode #messageInput, body.dark-mode #nicknameInput {
            background-color: #4a5568;
            border-color: #6a7a8e;
            color: #e2e8f0;
        }
        body.dark-mode #messageInput::placeholder, body.dark-mode #nicknameInput::placeholder {
            color: #a0aec0;
        }
        body.dark-mode .border-gray-200, body.dark-mode .border-gray-300 {
            border-color: #4a5568;
        }
        body.dark-mode .bg-gray-50 {
            background-color: #2d3748;
        }
        body.dark-mode .text-gray-700 {
            color: #e2e8f0;
        }
        body.dark-mode .text-gray-500 {
            color: #a0aec0;
        }
        body.dark-mode .text-blue-600 {
            color: #90cdf4;
        }
        body.dark-mode .mention-highlight {
            background-color: #6b46c1; /* Darker purple for highlight */
            color: #f6e05e; /* â˜…ä¿®æ­£: ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®è‰²ã‚’æ˜ã‚‹ã„é»„è‰²ã«â˜… */
        }
        body.dark-mode .online-indicator {
            background-color: #48bb78; /* Brighter green for dark mode */
        }
        body.dark-mode .offline-indicator {
            background-color: #a0aec0; /* Lighter gray for dark mode */
        }


        /* Custom scrollbar for messages div */
        #messages::-webkit-scrollbar {
            width: 8px;
        }
        #messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        body.dark-mode #messages::-webkit-scrollbar-track {
            background: #2d3748;
        }
        #messages::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        body.dark-mode #messages::-webkit-scrollbar-thumb {
            background: #a0aec0;
        }
        #messages::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        body.dark-mode #messages::-webkit-scrollbar-thumb:hover {
            background: #cbd5e0;
        }

        /* Fade-in animation for messages */
        .message-enter {
            opacity: 0;
            transform: translateY(10px);
        }
        .message-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }

        /* Mention highlight */
        .mention-highlight {
            background-color: #fff3cd; /* Yellowish background */
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: bold;
            /* Light mode: color inherits from parent (text-gray-900 which is #333) */
        }


        /* Online indicator */
        .online-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #28a745; /* Green */
            margin-left: 5px;
        }
        .offline-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #6c757d; /* Gray */
            margin-left: 5px;
        }

        /* Autocomplete dropdown */
        #mention-autocomplete {
            position: absolute;
            bottom: 100%; /* inputã®ä¸Š */
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 10;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        }
        body.dark-mode #mention-autocomplete {
            background-color: #2d3748;
            border-color: #4a5568;
        }
        #mention-autocomplete div {
            padding: 8px 12px;
            cursor: pointer;
            color: #333; /* Light mode text */
        }
        body.dark-mode #mention-autocomplete div {
            color: #e2e8f0; /* Dark mode text */
        }
        #mention-autocomplete div:hover {
            background-color: #f0f0f0;
        }
        body.dark-mode #mention-autocomplete div:hover {
            background-color: #4a5568;
        }

        /* Dark mode for custom message/confirm boxes */
        body.dark-mode #custom-message-box .bg-white,
        body.dark-mode #custom-confirm-box .bg-white {
            background-color: #2d3748; /* Dark container background */
        }
        body.dark-mode #custom-message-box .text-gray-700,
        body.dark-mode #custom-confirm-box .text-gray-700 {
            color: #e2e8f0; /* Light text */
        }
        body.dark-mode #custom-message-box .text-red-700,
        body.dark-mode #custom-confirm-box .text-red-700 {
            color: #fc8181; /* Lighter red for dark mode */
        }
        body.dark-mode #custom-message-box .text-yellow-700,
        body.dark-mode #custom-confirm-box .text-yellow-700 {
            color: #faf089; /* Lighter yellow for dark mode */
        }
        body.dark-mode #custom-message-box .text-blue-700,
        body.dark-mode #custom-confirm-box .text-blue-700 {
            color: #90cdf4; /* Lighter blue for dark mode */
        }
        body.dark-mode #message-box-ok-btn,
        body.dark-mode #confirm-box-ok-btn {
            background-color: #63b3ed; /* Lighter blue for dark mode button */
            color: #2d3748; /* Dark text for contrast */
        }
        body.dark-mode #message-box-ok-btn:hover,
        body.dark-mode #confirm-box-ok-btn:hover {
            background-color: #4299e1;
        }
        body.dark-mode #confirm-box-cancel-btn {
            background-color: #a0aec0; /* Lighter gray */
            color: #2d3748;
        }
        body.dark-mode #confirm-box-cancel-btn:hover {
            background-color: #cbd5e0;
        }
    </style>
</head>
<body>
    <div id="app-container" class="bg-white p-6 md:p-8 rounded-lg shadow-xl w-full max-w-md mx-4 sm:mx-auto border border-gray-200">
        <h1 class="text-2xl md:text-3xl font-bold text-center mb-4 text-blue-700">ä»Šæ—¥ã®å¾©ç¿’ãƒ¡ãƒ¢</h1>
        <p class="text-sm text-gray-600 text-center mb-6">â€» ã“ã®ãƒ„ãƒ¼ãƒ«ã¯å­¦ç¿’å†…å®¹ã®æŒ¯ã‚Šè¿”ã‚Šã‚„ç–‘å•ç‚¹ã®å…±æœ‰ã«ã”åˆ©ç”¨ãã ã•ã„ã€‚</p>

        <div id="loading-indicator" class="text-center text-gray-500 mb-4" style="display: none;">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-2"></div>
            <p id="loading-message" class="text-sm font-mono"></p>
        </div>

        <div id="user-info" class="text-sm text-gray-500 mb-4 hidden">
            ã‚ãªãŸã®ID: <span id="user-id-display" class="font-mono text-blue-600 break-all"></span>
        </div>

        <!-- Nickname setting section -->
        <div class="mb-4 p-3 border border-gray-200 rounded-md bg-gray-50">
            <label for="nicknameInput" class="block text-sm font-medium text-gray-700 mb-2">ã‚ãªãŸã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ :</label>
            <div class="flex gap-2">
                <input type="text" id="nicknameInput" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›"
                       class="flex-grow p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-400 text-sm">
                <button id="setNicknameBtn"
                        class="px-3 py-2 bg-green-500 text-white font-semibold rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400 transition-colors duration-200 shadow-sm text-sm">
                    è¨­å®š
                </button>
            </div>
            <p id="currentNicknameDisplay" class="text-xs text-gray-500 mt-2">ç¾åœ¨ã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ : <span class="font-bold text-gray-700"></span></p>
        </div>

        <!-- Online Users Section -->
        <div class="mb-4 p-3 border border-gray-200 rounded-md bg-gray-50">
            <h3 class="text-base font-semibold text-gray-700 mb-2">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼:</h3>
            <div id="onlineUsersList" class="text-sm text-gray-600 flex flex-wrap gap-x-3 gap-y-1">
                <!-- Online users will be listed here -->
                <p class="text-gray-500">èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
        </div>

        <div id="messages" class="border border-gray-300 p-4 h-96 overflow-y-auto mb-4 rounded-md bg-gray-50 scroll-smooth">
            <!-- Messages will be displayed here -->
        </div>

        <div class="flex justify-between items-center mb-4">
            <button id="clearChatBtn" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 transition-colors duration-200 shadow-md text-sm">
                ãƒãƒ£ãƒƒãƒˆã‚’ã‚¯ãƒªã‚¢
            </button>
            <div class="flex gap-2">
                <button id="toggleNotificationBtn" class="px-4 py-2 bg-purple-500 text-white font-semibold rounded-md hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-400 transition-colors duration-200 shadow-md text-sm">
                    é€šçŸ¥ON
                </button>
                <button id="toggleDarkModeBtn" class="px-4 py-2 bg-gray-700 text-white font-semibold rounded-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-600 transition-colors duration-200 shadow-md text-sm">
                    ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰
                </button>
                <button id="helpBtn" class="px-4 py-2 bg-gray-500 text-white font-semibold rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 transition-colors duration-200 shadow-md text-sm">
                    ãƒ˜ãƒ«ãƒ—
                </button>
            </div>
        </div>

        <div id="message-input-container" class="relative flex gap-3">
            <input type="text" id="messageInput" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›..."
                   class="flex-grow p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
            <div id="mention-autocomplete" class="hidden"></div> <!-- Mention autocomplete -->
            <button id="sendMessageBtn"
                    class="px-5 py-3 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-colors duration-200 shadow-md">
                é€ä¿¡
            </button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, getDocs, writeBatch, doc, setDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        // Firebase è¨­å®š - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰æä¾›ã•ã‚ŒãŸè¨­å®šã‚’ä½¿ç”¨
        const firebaseConfig = {
            apiKey: "AIzaSyDggfvHZMmox-_2N8lT9UjzmJTH36jSNy0",
            authDomain: "loiloidiot-mail.firebaseapp.com",
            projectId: "loiloidiot-mail",
            storageBucket: "loiloidiot-mail.firebasestorage.app",
            messagingSenderId: "457273591838",
            appId: "1:457273591838:web:5c30edaf7a908061f9860f",
            measurementId: "G-QX07FG8730"
        };

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ID (Canvasç’°å¢ƒã‹ã‚‰æä¾›ã•ã‚Œã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Firebase åˆæœŸåŒ–
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // DOMè¦ç´ ã®å–å¾—
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const clearChatBtn = document.getElementById('clearChatBtn');
        const appContainer = document.getElementById('app-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        const loadingMessage = document.getElementById('loading-message'); // æ–°ã—ã„è¦ç´ 
        const userIdDisplay = document.getElementById('user-id-display');
        const userInfoDiv = document.getElementById('user-info');
        const nicknameInput = document.getElementById('nicknameInput');
        const setNicknameBtn = document.getElementById('setNicknameBtn');
        const currentNicknameDisplay = document.querySelector('#currentNicknameDisplay span');
        const onlineUsersList = document.getElementById('onlineUsersList');
        const toggleNotificationBtn = document.getElementById('toggleNotificationBtn');
        const toggleDarkModeBtn = document.getElementById('toggleDarkModeBtn');
        const helpBtn = document.getElementById('helpBtn');
        const mentionAutocomplete = document.getElementById('mention-autocomplete');

        // NGãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ
        const ngWords = ['vpn', 'ãƒ—ãƒ­ã‚­ã‚·', 'è„±å‡º', 'ç›£è¦–', 'ç®¡ç†è€…', 'proxy', 'escape', 'monitor', 'admin'];
        const ngWordReplacement = 'ï¿½';

        let userNickname = localStorage.getItem('userNickname');
        let currentUserId = null;
        let notificationEnabled = localStorage.getItem('notificationEnabled') === 'true';
        let darkModeEnabled = localStorage.getItem('darkModeEnabled') === 'true';
        let onlineUsers = {}; // { userId: nickname }
        let allKnownNicknames = new Set();

        // --- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ---
        const loadingMessages = [
            "Initializing secure connection...",
            "Authenticating anonymous user...",
            "Fetching real-time data...",
            "Synchronizing chat history...",
            "Establishing peer-to-peer link...",
            "Encrypting data streams...",
            "Optimizing network protocols...",
            "Preparing user interface...",
            "Ready for communication."
        ];
        let loadingMessageIndex = 0;
        let loadingInterval;

        function startLoadingAnimation() {
            loadingIndicator.style.display = 'block';
            loadingMessageIndex = 0;
            loadingMessage.textContent = loadingMessages[loadingMessageIndex]; // åˆå›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®š
            loadingInterval = setInterval(() => {
                loadingMessageIndex = (loadingMessageIndex + 1) % loadingMessages.length;
                loadingMessage.textContent = loadingMessages[loadingMessageIndex];
            }, 1500); // 1.5ç§’ã”ã¨ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¤‰æ›´
        }

        function stopLoadingAnimation() {
            loadingIndicator.style.display = 'none';
            clearInterval(loadingInterval);
        }

        // --- ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã®åˆæœŸè¨­å®š ---
        if (darkModeEnabled) {
            document.body.classList.add('dark-mode');
            toggleDarkModeBtn.textContent = 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰';
        } else {
            document.body.classList.remove('dark-mode');
            toggleDarkModeBtn.textContent = 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰';
        }

        // --- ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ é–¢é€£ ---
        const generateAnonymousNickname = () => {
            const adjectives = ['é™ã‹ãª', 'ç´ æ—©ã„', 'è³¢ã„', 'ç§˜å¯†ã®', 'å‹‡æ•¢ãª', 'è‡ªç”±ãª', 'é™å¯‚ã®', 'è¼ã', 'è¦‹ãˆãªã„', 'æœªæ¥ã®'];
            const nouns = ['å­¦ç¿’è€…', 'æ¢ç©¶è€…', 'æ€ç´¢å®¶', 'è¨˜éŒ²è€…', 'é–‹æ‹“è€…', 'è¦³å¯Ÿè€…', 'æ¡ˆå†…äºº', 'ä¼é”è€…', 'åé›†å®¶', 'çŸ¥è­˜äºº'];
            const randomAdjective = adjectives[Math.floor(Math.random() * adjectives.length)];
            const randomNoun = nouns[Math.floor(Math.random() * nouns.length)];
            const randomNumber = Math.floor(Math.random() * 900) + 100;
            return `${randomAdjective}${randomNoun}${randomNumber}`;
        };

        if (!userNickname) {
            userNickname = generateAnonymousNickname();
            localStorage.setItem('userNickname', userNickname);
        }
        nicknameInput.value = userNickname;
        currentNicknameDisplay.textContent = userNickname;

        setNicknameBtn.addEventListener('click', () => {
            const newNickname = nicknameInput.value.trim();
            if (newNickname) {
                userNickname = newNickname;
                localStorage.setItem('userNickname', userNickname);
                currentNicknameDisplay.textContent = userNickname;
                displayMessageBox(`ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’ã€Œ${userNickname}ã€ã«è¨­å®šã—ã¾ã—ãŸã€‚`, "ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ è¨­å®š", "blue");
                if (currentUserId) {
                    updateUserOnlineStatus(currentUserId, userNickname);
                }
            } else {
                displayMessageBox("ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", "ã‚¨ãƒ©ãƒ¼", "red");
            }
        });

        // --- èªè¨¼ã¨Firestoreã®åˆæœŸåŒ– ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                userIdDisplay.textContent = currentUserId;
                userInfoDiv.classList.remove('hidden');
                stopLoadingAnimation(); // èªè¨¼æˆåŠŸã§ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°åœæ­¢
                console.log("èªè¨¼æˆåŠŸï¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:", currentUserId);

                updateUserOnlineStatus(currentUserId, userNickname);
                setInterval(() => updateUserOnlineStatus(currentUserId, userNickname), 30 * 1000);

                const messagesCollectionRef = collection(db, `artifacts/${appId}/public/data/messages`);
                const q = query(messagesCollectionRef, orderBy('timestamp', 'asc'));

                onSnapshot(q, async (snapshot) => {
                    snapshot.docChanges().forEach(async (change) => {
                        if (change.type === "added") {
                            const message = change.doc.data();
                            const messageId = change.doc.id;
                            
                            if (currentUserId && message.senderId !== currentUserId && (!message.readBy || !message.readBy.includes(currentUserId))) {
                                try {
                                    await updateDoc(doc(db, `artifacts/${appId}/public/data/messages`, messageId), {
                                        readBy: arrayUnion(currentUserId)
                                    });
                                } catch (error) {
                                    console.error("Error updating read status:", error);
                                }
                            }

                            allKnownNicknames.add(message.author);

                            const messageElement = document.createElement('div');
                            messageElement.classList.add('message', 'mb-2', 'p-3', 'rounded-lg', 'break-words', 'relative', 'overflow-hidden');
                            messageElement.classList.add('bg-blue-100', 'text-blue-800', 'shadow-sm', 'message-enter');
                            messageElement.dataset.docId = messageId;

                            const timestamp = message.timestamp ? message.timestamp.toDate().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }) : 'é€ä¿¡ä¸­...';
                            
                            let processedText = message.text;
                            ngWords.forEach(word => {
                                const regex = new RegExp(`\\b${word}\\b`, 'gi');
                                processedText = processedText.replace(regex, ngWordReplacement.repeat(word.length));
                            });

                            const mentionRegex = /@([^\s]+)/g;
                            processedText = processedText.replace(mentionRegex, (match, mentionedNickname) => {
                                if (allKnownNicknames.has(mentionedNickname)) {
                                    return `<span class="mention-highlight">@${mentionedNickname}</span>`;
                                }
                                return match;
                            });

                            const readCount = (message.readBy ? message.readBy.length : 0) - (message.senderId === currentUserId ? 1 : 0);
                            const readStatus = readCount > 0 ? `æ—¢èª­ ${readCount}` : '';

                            messageElement.innerHTML = `
                                <div class="font-semibold text-blue-700">${message.author}</div>
                                <div class="text-gray-900">${processedText}</div>
                                <div class="text-xs text-gray-500 mt-1 text-right">
                                    ${timestamp} ${readStatus ? `<span class="ml-2 text-gray-600">${readStatus}</span>` : ''}
                                </div>
                            `;
                            messagesDiv.appendChild(messageElement);

                            setTimeout(() => messageElement.classList.add('message-enter-active'), 10);
                            messagesDiv.scrollTop = messagesDiv.scrollHeight;

                            if (document.hidden) {
                                const isMentioned = message.mentions && message.mentions.includes(currentUserId);
                                if (notificationEnabled || isMentioned) {
                                    if (Notification.permission === "granted") {
                                        new Notification(`${message.author}ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸`, {
                                            body: message.text,
                                            icon: 'https://placehold.co/48x48/007bff/ffffff?text=M' // ä»®ã®ã‚¢ã‚¤ã‚³ãƒ³
                                        });
                                    } else if (Notification.permission !== "denied") {
                                        Notification.requestPermission().then(permission => {
                                            if (permission === "granted") {
                                                new Notification(`${message.author}ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸`, {
                                                    body: message.text,
                                                    icon: 'https://placehold.co/48x48/007bff/ffffff?text=M'
                                                });
                                            }
                                        });
                                    }
                                }
                            }

                        } else if (change.type === "removed") {
                            const removedMessageId = change.doc.id;
                            const messageElements = messagesDiv.children;
                            for (let i = 0; i < messageElements.length; i++) {
                                if (messageElements[i].dataset.docId === removedMessageId) {
                                    messagesDiv.removeChild(messageElements[i]);
                                    break;
                                }
                            }
                        } else if (change.type === "modified") {
                            const modifiedMessage = change.doc.data();
                            const modifiedMessageId = change.doc.id;
                            const messageElement = messagesDiv.querySelector(`[data-doc-id="${modifiedMessageId}"]`);
                            if (messageElement) {
                                const timestamp = modifiedMessage.timestamp ? modifiedMessage.timestamp.toDate().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }) : 'é€ä¿¡ä¸­...';
                                
                                let processedText = modifiedMessage.text;
                                ngWords.forEach(word => {
                                    const regex = new RegExp(`\\b${word}\\b`, 'gi');
                                    processedText = processedText.replace(regex, ngWordReplacement.repeat(word.length));
                                });
                                const mentionRegex = /@([^\s]+)/g;
                                processedText = processedText.replace(mentionRegex, (match, mentionedNickname) => {
                                    if (allKnownNicknames.has(mentionedNickname)) {
                                        return `<span class="mention-highlight">@${mentionedNickname}</span>`;
                                    }
                                    return match;
                                });

                                const readCount = (modifiedMessage.readBy ? modifiedMessage.readBy.length : 0) - (modifiedMessage.senderId === currentUserId ? 1 : 0);
                                const readStatus = readCount > 0 ? `æ—¢èª­ ${readCount}` : '';

                                messageElement.innerHTML = `
                                    <div class="font-semibold text-blue-700">${modifiedMessage.author}</div>
                                    <div class="text-gray-900">${processedText}</div>
                                    <div class="text-xs text-gray-500 mt-1 text-right">
                                        ${timestamp} ${readStatus ? `<span class="ml-2 text-gray-600">${readStatus}</span>` : ''}
                                    </div>
                                `;
                            }
                        }
                    });
                }, (error) => {
                    console.error("Error getting real-time updates: ", error);
                    displayMessageBox("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", "ã‚¨ãƒ©ãƒ¼", "red");
                });

                const usersCollectionRef = collection(db, `artifacts/${appId}/public/data/users`);
                const usersQuery = query(usersCollectionRef, orderBy('lastSeen', 'desc'));

                onSnapshot(usersQuery, (snapshot) => {
                    onlineUsers = {};
                    onlineUsersList.innerHTML = '';
                    const now = Date.now();
                    const onlineThreshold = 60 * 1000;

                    let hasOnlineUsers = false;
                    snapshot.forEach(doc => {
                        const userData = doc.data();
                        if (userData.lastSeen && (now - userData.lastSeen.toDate().getTime() < onlineThreshold)) {
                            onlineUsers[userData.userId] = userData.nickname;
                            const userSpan = document.createElement('span');
                            userSpan.className = 'flex items-center text-gray-700';
                            userSpan.innerHTML = `${userData.nickname} <span class="online-indicator"></span>`;
                            onlineUsersList.appendChild(userSpan);
                            hasOnlineUsers = true;
                            allKnownNicknames.add(userData.nickname);
                        }
                    });

                    if (!hasOnlineUsers) {
                        onlineUsersList.innerHTML = '<p class="text-gray-500">ç¾åœ¨ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã„ã¾ã›ã‚“ã€‚</p>';
                    }
                    console.log("ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼:", onlineUsers);
                }, (error) => {
                    console.error("Error getting online users:", error);
                    // æ¨©é™ã‚¨ãƒ©ãƒ¼ã®å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥
                    if (error.code === 'permission-denied') {
                        displayMessageBox("ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«æ¨©é™ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚Firebaseã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", "ã‚¨ãƒ©ãƒ¼", "red");
                        onlineUsersList.innerHTML = '<p class="text-red-500">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ¨©é™ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</p>'; // Visual cue for permission error
                    } else {
                        displayMessageBox("ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", "ã‚¨ãƒ©ãƒ¼", "red");
                    }
                });

            } else {
                startLoadingAnimation(); // èªè¨¼é–‹å§‹æ™‚ã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
                console.log("èªè¨¼è©¦è¡Œä¸­...");
                try {
                    await signInAnonymously(auth);
                    console.log("åŒ¿åèªè¨¼ã‚’è©¦ã¿ã¾ã—ãŸã€‚");
                } catch (error) {
                    console.error("èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
                    displayMessageBox("èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¢ãƒ—ãƒªã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚", "ã‚¨ãƒ©ãƒ¼", "red");
                    stopLoadingAnimation(); // èªè¨¼å¤±æ•—ã§ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°åœæ­¢
                }
            }
        });

        async function updateUserOnlineStatus(userId, nickname) {
            if (!userId) return;
            try {
                const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
                await setDoc(userDocRef, {
                    userId: userId,
                    nickname: nickname,
                    lastSeen: serverTimestamp()
                }, { merge: true });
            } catch (error) {
                console.error("ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
                // æ¨©é™ã‚¨ãƒ©ãƒ¼ã®å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥
                if (error.code === 'permission-denied') {
                    displayMessageBox("ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã®æ›´æ–°ã«æ¨©é™ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚Firebaseã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", "ã‚¨ãƒ©ãƒ¼", "red");
                }
            }
        }

        sendMessageBtn.addEventListener('click', async () => {
            const messageText = messageInput.value.trim();
            if (messageText && currentUserId) {
                let maskedMessage = messageText;
                ngWords.forEach(word => {
                    const regex = new RegExp(`\\b${word}\\b`, 'gi');
                    maskedMessage = maskedMessage.replace(regex, ngWordReplacement.repeat(word.length));
                });

                const mentionedUserIds = [];
                const mentionRegex = /@([^\s]+)/g;
                let match;
                while ((match = mentionRegex.exec(messageText)) !== null) {
                    const mentionedNickname = match[1];
                    for (const userId in onlineUsers) {
                        if (onlineUsers[userId] === mentionedNickname) {
                            mentionedUserIds.push(userId);
                            break;
                        }
                    }
                }

                try {
                    const messagesCollectionRef = collection(db, `artifacts/${appId}/public/data/messages`);
                    await addDoc(messagesCollectionRef, {
                        author: userNickname,
                        senderId: currentUserId,
                        text: maskedMessage,
                        timestamp: serverTimestamp(),
                        readBy: [currentUserId],
                        mentions: mentionedUserIds
                    });
                    messageInput.value = '';
                    console.log("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æˆåŠŸï¼");
                } catch (error) {
                    console.error("Error writing document: ", error);
                    displayMessageBox("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", "ã‚¨ãƒ©ãƒ¼", "red");
                }
            } else if (!currentUserId) {
                displayMessageBox("ã¾ã èªè¨¼ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚", "æ³¨æ„", "yellow");
                console.log("èªè¨¼ãŒå®Œäº†ã—ã¦ã„ãªã„ãŸã‚ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã§ãã¾ã›ã‚“ã€‚");
            }
        });

        clearChatBtn.addEventListener('click', () => {
            displayConfirmBox("æœ¬å½“ã«ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚", "ãƒãƒ£ãƒƒãƒˆã‚¯ãƒªã‚¢ã®ç¢ºèª", "red", async (confirmed) => {
                if (confirmed) {
                    try {
                        const messagesCollectionRef = collection(db, `artifacts/${appId}/public/data/messages`);
                        const querySnapshot = await getDocs(messagesCollectionRef);
                        
                        const batch = writeBatch(db);
                        querySnapshot.docs.forEach((d) => {
                            batch.delete(doc(db, `artifacts/${appId}/public/data/messages`, d.id));
                        });
                        await batch.commit();

                        messagesDiv.innerHTML = ''; 
                        displayMessageBox("ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸã€‚", "å®Œäº†", "blue");
                        console.log("ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸã€‚");
                    } catch (error) {
                        console.error("Error clearing chat: ", error);
                        displayMessageBox("ãƒãƒ£ãƒƒãƒˆã®ã‚¯ãƒªã‚¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", "ã‚¨ãƒ©ãƒ¼", "red");
                    }
                }
            });
        });

        toggleNotificationBtn.textContent = notificationEnabled ? 'é€šçŸ¥OFF' : 'é€šçŸ¥ON';

        toggleNotificationBtn.addEventListener('click', () => {
            if (Notification.permission === "default") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        notificationEnabled = true;
                        localStorage.setItem('notificationEnabled', 'true');
                        toggleNotificationBtn.textContent = 'é€šçŸ¥OFF';
                        displayMessageBox("é€šçŸ¥ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸã€‚", "é€šçŸ¥è¨­å®š", "blue");
                    } else {
                        notificationEnabled = false;
                        localStorage.setItem('notificationEnabled', 'false');
                        toggleNotificationBtn.textContent = 'é€šçŸ¥ON';
                        displayMessageBox("é€šçŸ¥ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‹ã‚‰è¨±å¯ã—ã¦ãã ã•ã„ã€‚", "é€šçŸ¥è¨­å®š", "red");
                    }
                });
            } else if (Notification.permission === "granted") {
                notificationEnabled = !notificationEnabled;
                localStorage.setItem('notificationEnabled', notificationEnabled.toString());
                toggleNotificationBtn.textContent = notificationEnabled ? 'é€šçŸ¥OFF' : 'é€šçŸ¥ON';
                displayMessageBox(`é€šçŸ¥ãŒ${notificationEnabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}ã«ãªã‚Šã¾ã—ãŸã€‚`, "é€šçŸ¥è¨­å®š", "blue");
            } else if (Notification.permission === "denied") {
                displayMessageBox("é€šçŸ¥ãŒæ‹’å¦ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‹ã‚‰è¨±å¯ã—ã¦ãã ã•ã„ã€‚", "é€šçŸ¥è¨­å®š", "red");
            }
        });

        // --- ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ ---
        toggleDarkModeBtn.addEventListener('click', () => {
            darkModeEnabled = !darkModeEnabled;
            localStorage.setItem('darkModeEnabled', darkModeEnabled.toString());
            if (darkModeEnabled) {
                document.body.classList.add('dark-mode');
                toggleDarkModeBtn.textContent = 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰';
            } else {
                document.body.classList.remove('dark-mode');
                toggleDarkModeBtn.textContent = 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰';
            }
        });

        // --- ãƒ˜ãƒ«ãƒ—æ©Ÿèƒ½ ---
        helpBtn.addEventListener('click', () => {
            const helpMessage = `
                <p class="mb-2">ã“ã®ã‚¢ãƒ—ãƒªã¯ã€å­¦ç¿’ãƒ¡ãƒ¢å…±æœ‰ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
                <ul class="list-disc list-inside mb-4">
                    <li><strong>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡:</strong> ä¸‹ã®å…¥åŠ›æ¬„ã«ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã€ã€Œé€ä¿¡ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</li>
                    <li><strong>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ è¨­å®š:</strong> ä¸Šéƒ¨ã®å…¥åŠ›æ¬„ã«å¥½ããªãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã€ã€Œè¨­å®šã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚è¨­å®šã—ãªã„å ´åˆã¯è‡ªå‹•ã§åŒ¿åãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ãŒå‰²ã‚ŠæŒ¯ã‚‰ã‚Œã¾ã™ã€‚</li>
                    <li><strong>ãƒãƒ£ãƒƒãƒˆã‚¯ãƒªã‚¢:</strong> ã€Œãƒãƒ£ãƒƒãƒˆã‚’ã‚¯ãƒªã‚¢ã€ãƒœã‚¿ãƒ³ã§ã€ã™ã¹ã¦ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã§ãã¾ã™ã€‚ï¼ˆå…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰</li>
                    <li><strong>ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³:</strong> ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…ã§ã€Œ@ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã€ã¨å…¥åŠ›ã™ã‚‹ã¨ã€ç‰¹å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã§ãã¾ã™ã€‚ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li>
                    <li><strong>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼:</strong> ã€Œã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€æ¬„ã§ã€ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç¢ºèªã§ãã¾ã™ã€‚</li>
                    <li><strong>æ—¢èª­æ©Ÿèƒ½:</strong> ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å³ä¸‹ã«ã€Œæ—¢èª­ Xã€ã¨è¡¨ç¤ºã•ã‚Œã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã‚“ã ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ•°ãŒã‚ã‹ã‚Šã¾ã™ã€‚ï¼ˆé€ä¿¡è€…è‡ªèº«ã¯ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã¾ã›ã‚“ï¼‰</li>
                    <li><strong>é€šçŸ¥æ©Ÿèƒ½:</strong> ã€Œé€šçŸ¥ON/OFFã€ãƒœã‚¿ãƒ³ã§ã€æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå±Šã„ãŸéš›ã®ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚é€šçŸ¥OFFã§ã‚‚ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã•ã‚ŒãŸå ´åˆã¯é€šçŸ¥ã•ã‚Œã¾ã™ã€‚</li>
                    <li><strong>NGãƒ¯ãƒ¼ãƒ‰:</strong> ç‰¹å®šã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯è‡ªå‹•çš„ã«ã€ŒğŸ™ã€ã«ãƒã‚¹ã‚¯ã•ã‚Œã¾ã™ã€‚</li>
                </ul>
                <p class="text-sm text-gray-600">â€» ã“ã®ã‚¢ãƒ—ãƒªã¯å®Ÿé¨“çš„ãªãƒ„ãƒ¼ãƒ«ã§ã‚ã‚Šã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®å®Œå…¨ãªä¿è¨¼ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚åˆ©ç”¨ã¯è‡ªå·±è²¬ä»»ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚</p>
            `;
            displayMessageBox(helpMessage, "ä½¿ã„æ–¹ï¼ˆãƒ˜ãƒ«ãƒ—ï¼‰", "blue");
        });

        // --- ãã®ä»–ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessageBtn.click();
            }
        });

        messageInput.addEventListener('input', () => {
            const text = messageInput.value;
            const lastAtIndex = text.lastIndexOf('@');

            console.log("--- ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆãƒ‡ãƒãƒƒã‚° ---");
            console.log("Current messageInput value:", text);
            console.log("Last '@' index:", lastAtIndex);

            if (lastAtIndex !== -1 && text.substring(lastAtIndex).includes(' ')) {
                console.log("Space detected after @, hiding autocomplete.");
                mentionAutocomplete.classList.add('hidden');
                return;
            }

            if (lastAtIndex !== -1) {
                const searchTerm = text.substring(lastAtIndex + 1);
                console.log("Search term for mention:", searchTerm);
                console.log("All known nicknames (before filter):", Array.from(allKnownNicknames)); // allKnownNicknamesã®å†…å®¹ã‚’ç¢ºèª

                const filteredNicknames = Array.from(allKnownNicknames).filter(nickname =>
                    nickname.toLowerCase().startsWith(searchTerm.toLowerCase()) && nickname !== userNickname
                );
                console.log("Filtered nicknames for autocomplete:", filteredNicknames); // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°çµæœã‚’ç¢ºèª

                mentionAutocomplete.innerHTML = '';
                if (filteredNicknames.length > 0) {
                    filteredNicknames.forEach(nickname => {
                        const div = document.createElement('div');
                        div.textContent = nickname;
                        div.addEventListener('click', () => {
                            messageInput.value = text.substring(0, lastAtIndex) + `@${nickname} `;
                            mentionAutocomplete.classList.add('hidden');
                            messageInput.focus();
                        });
                        mentionAutocomplete.appendChild(div);
                    });
                    mentionAutocomplete.classList.remove('hidden');
                } else {
                    mentionAutocomplete.classList.add('hidden');
                }
            } else {
                mentionAutocomplete.classList.add('hidden');
            }
            console.log("--- ãƒ‡ãƒãƒƒã‚°çµ‚äº† ---");
        });

        document.addEventListener('click', (event) => {
            if (!messageInput.contains(event.target) && !mentionAutocomplete.contains(event.target)) {
                mentionAutocomplete.classList.add('hidden');
            }
        });

        // ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤ºé–¢æ•° (alertã®ä»£æ›¿)
        function displayMessageBox(message, title = "é€šçŸ¥", type = "blue") {
            const existingBox = document.getElementById('custom-message-box');
            if (existingBox) existingBox.remove();

            const box = document.createElement('div');
            box.id = 'custom-message-box';
            box.className = `fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50`;
            box.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 border-t-4 ${type === 'red' ? 'border-red-500' : type === 'yellow' ? 'border-yellow-500' : 'border-blue-500'}">
                    <h3 class="text-lg font-bold mb-3 ${type === 'red' ? 'text-red-700' : type === 'yellow' ? 'text-yellow-700' : 'text-blue-700'}">${title}</h3>
                    <div class="text-gray-700 mb-4 max-h-96 overflow-y-auto">${message}</div>
                    <button id="message-box-ok-btn" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400">OK</button>
                </div>
            `;
            document.body.appendChild(box);

            document.getElementById('message-box-ok-btn').addEventListener('click', () => {
                box.remove();
            });
        }

        // ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒœãƒƒã‚¯ã‚¹è¡¨ç¤ºé–¢æ•° (confirmã®ä»£æ›¿)
        function displayConfirmBox(message, title = "ç¢ºèª", type = "blue", callback) {
            const existingBox = document.getElementById('custom-confirm-box');
            if (existingBox) existingBox.remove();

            const box = document.createElement('div');
            box.id = 'custom-confirm-box';
            box.className = `fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50`;
            box.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 border-t-4 ${type === 'red' ? 'border-red-500' : type === 'yellow' ? 'border-yellow-500' : 'border-blue-500'}">
                    <h3 class="text-lg font-bold mb-3 ${type === 'red' ? 'text-red-700' : type === 'yellow' ? 'text-yellow-700' : 'text-blue-700'}">${title}</h3>
                    <p class="text-gray-700 mb-4">${message}</p>
                    <div class="flex justify-end gap-3">
                        <button id="confirm-box-cancel-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button id="confirm-box-ok-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400">OK</button>
                    </div>
                </div>
            `;
            document.body.appendChild(box);

            document.getElementById('confirm-box-ok-btn').addEventListener('click', () => {
                box.remove();
                callback(true);
            });

            document.getElementById('confirm-box-cancel-btn').addEventListener('click', () => {
                box.remove();
                callback(false);
            });
        }
    </script>
</body>
</html>
