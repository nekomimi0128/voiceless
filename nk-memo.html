<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>今日の復習メモ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* 基本スタイルとトランジション */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            transition: background-color 0.5s ease-in-out, color 0.5s ease-in-out;
        }
        #app-container {
            transition: background-color 0.5s ease-in-out, border-color 0.5s ease-in-out, box-shadow 0.5s ease-in-out;
        }
        .message {
            transition: background-color 0.5s ease-in-out, color 0.5s ease-in-out;
        }
        #messageInput, #nicknameInput {
            transition: background-color 0.5s ease-in-out, border-color 0.5s ease-in-out, color 0.5s ease-in-out;
        }
        .bg-gray-50, .bg-white, .border-gray-200, .border-gray-300 {
            transition: background-color 0.5s ease-in-out, border-color 0.5s ease-in-out;
        }
        .text-gray-600, .text-gray-500, .text-gray-700, .text-blue-700, .text-blue-600, .text-gray-900 {
            transition: color 0.5s ease-in-out;
        }
        /* ボタンのトランジション */
        button {
            transition: background-color 0.3s ease-in-out, color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }

        /* ダークモードスタイル */
        body.dark-mode {
            background-color: #1a202c; /* ダークな背景 */
            color: #e2e8f0; /* 明るい文字色 */
        }
        body.dark-mode #app-container {
            background-color: #2d3748; /* ダークなコンテナ背景 */
            border-color: #4a5568;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        body.dark-mode h1 {
            color: #90cdf4; /* 明るい青 */
        }
        body.dark-mode p.text-gray-600 {
            color: #cbd5e0; /* 明るいグレー */
        }
        body.dark-mode #messages {
            background-color: #242d3b; /* ダークなメッセージエリア背景 */
            border-color: #4a5568;
        }
        body.dark-mode .message {
            background-color: #4a5568; /* ダークなメッセージ背景 */
            color: #e2e8f0; /* 明るいメッセージ文字色 */
        }
        body.dark-mode .message .font-semibold {
            color: #90cdf4; /* 明るい青 */
        }
        body.dark-mode .message .text-gray-900 {
            color: #e2e8f0;
        }
        body.dark-mode .message .text-gray-500 {
            color: #a0aec0;
        }
        body.dark-mode .message .text-gray-600 {
            color: #a0aec0;
        }
        body.dark-mode #messageInput, body.dark-mode #nicknameInput {
            background-color: #4a5568;
            border-color: #6a7a8e;
            color: #e2e8f0;
        }
        body.dark-mode #messageInput::placeholder, body.dark-mode #nicknameInput::placeholder {
            color: #a0aec0;
        }
        body.dark-mode .border-gray-200, body.dark-mode .border-gray-300 {
            border-color: #4a5568;
        }
        body.dark-mode .bg-gray-50 {
            background-color: #2d3748;
        }
        body.dark-mode .text-gray-700 {
            color: #e2e8f0;
        }
        body.dark-mode .text-gray-500 {
            color: #a0aec0;
        }
        body.dark-mode .text-blue-600 {
            color: #90cdf4;
        }
        body.dark-mode .mention-highlight {
            background-color: #6b46c1; /* Darker purple for highlight */
            color: #f6e05e; /* ★修正: メンションテキストの色を明るい黄色に★ */
        }
        body.dark-mode .online-indicator {
            background-color: #48bb78; /* Brighter green for dark mode */
        }
        body.dark-mode .offline-indicator {
            background-color: #a0aec0; /* Lighter gray for dark mode */
        }


        /* Custom scrollbar for messages div */
        #messages::-webkit-scrollbar {
            width: 8px;
        }
        #messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        body.dark-mode #messages::-webkit-scrollbar-track {
            background: #2d3748;
        }
        #messages::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        body.dark-mode #messages::-webkit-scrollbar-thumb {
            background: #a0aec0;
        }
        #messages::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        body.dark-mode #messages::-webkit-scrollbar-thumb:hover {
            background: #cbd5e0;
        }

        /* Fade-in animation for messages */
        .message-enter {
            opacity: 0;
            transform: translateY(10px);
        }
        .message-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }

        /* Mention highlight */
        .mention-highlight {
            background-color: #fff3cd; /* Yellowish background */
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: bold;
            /* Light mode: color inherits from parent (text-gray-900 which is #333) */
        }


        /* Online indicator */
        .online-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #28a745; /* Green */
            margin-left: 5px;
        }
        .offline-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #6c757d; /* Gray */
            margin-left: 5px;
        }

        /* Autocomplete dropdown */
        #mention-autocomplete {
            position: absolute;
            bottom: 100%; /* inputの上 */
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 10;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        }
        body.dark-mode #mention-autocomplete {
            background-color: #2d3748;
            border-color: #4a5568;
        }
        #mention-autocomplete div {
            padding: 8px 12px;
            cursor: pointer;
            color: #333; /* Light mode text */
        }
        body.dark-mode #mention-autocomplete div {
            color: #e2e8f0; /* Dark mode text */
        }
        #mention-autocomplete div:hover {
            background-color: #f0f0f0;
        }
        body.dark-mode #mention-autocomplete div:hover {
            background-color: #4a5568;
        }

        /* Dark mode for custom message/confirm boxes */
        body.dark-mode #custom-message-box .bg-white,
        body.dark-mode #custom-confirm-box .bg-white {
            background-color: #2d3748; /* Dark container background */
        }
        body.dark-mode #custom-message-box .text-gray-700,
        body.dark-mode #custom-confirm-box .text-gray-700 {
            color: #e2e8f0; /* Light text */
        }
        body.dark-mode #custom-message-box .text-red-700,
        body.dark-mode #custom-confirm-box .text-red-700 {
            color: #fc8181; /* Lighter red for dark mode */
        }
        body.dark-mode #custom-message-box .text-yellow-700,
        body.dark-mode #custom-confirm-box .text-yellow-700 {
            color: #faf089; /* Lighter yellow for dark mode */
        }
        body.dark-mode #custom-message-box .text-blue-700,
        body.dark-mode #custom-confirm-box .text-blue-700 {
            color: #90cdf4; /* Lighter blue for dark mode */
        }
        body.dark-mode #message-box-ok-btn,
        body.dark-mode #confirm-box-ok-btn {
            background-color: #63b3ed; /* Lighter blue for dark mode button */
            color: #2d3748; /* Dark text for contrast */
        }
        body.dark-mode #message-box-ok-btn:hover,
        body.dark-mode #confirm-box-ok-btn:hover {
            background-color: #4299e1;
        }
        body.dark-mode #confirm-box-cancel-btn {
            background-color: #a0aec0; /* Lighter gray */
            color: #2d3748;
        }
        body.dark-mode #confirm-box-cancel-btn:hover {
            background-color: #cbd5e0;
        }
    </style>
</head>
<body>
    <div id="app-container" class="bg-white p-6 md:p-8 rounded-lg shadow-xl w-full max-w-md mx-4 sm:mx-auto border border-gray-200">
        <h1 class="text-2xl md:text-3xl font-bold text-center mb-4 text-blue-700">今日の復習メモ</h1>
        <p class="text-sm text-gray-600 text-center mb-6">※ このツールは学習内容の振り返りや疑問点の共有にご利用ください。</p>

        <div id="loading-indicator" class="text-center text-gray-500 mb-4" style="display: none;">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-2"></div>
            <p id="loading-message" class="text-sm font-mono"></p>
        </div>

        <div id="user-info" class="text-sm text-gray-500 mb-4 hidden">
            あなたのID: <span id="user-id-display" class="font-mono text-blue-600 break-all"></span>
        </div>

        <!-- Nickname setting section -->
        <div class="mb-4 p-3 border border-gray-200 rounded-md bg-gray-50">
            <label for="nicknameInput" class="block text-sm font-medium text-gray-700 mb-2">あなたのニックネーム:</label>
            <div class="flex gap-2">
                <input type="text" id="nicknameInput" placeholder="ニックネームを入力"
                       class="flex-grow p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-400 text-sm">
                <button id="setNicknameBtn"
                        class="px-3 py-2 bg-green-500 text-white font-semibold rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400 transition-colors duration-200 shadow-sm text-sm">
                    設定
                </button>
            </div>
            <p id="currentNicknameDisplay" class="text-xs text-gray-500 mt-2">現在のニックネーム: <span class="font-bold text-gray-700"></span></p>
        </div>

        <!-- Online Users Section -->
        <div class="mb-4 p-3 border border-gray-200 rounded-md bg-gray-50">
            <h3 class="text-base font-semibold text-gray-700 mb-2">オンラインユーザー:</h3>
            <div id="onlineUsersList" class="text-sm text-gray-600 flex flex-wrap gap-x-3 gap-y-1">
                <!-- Online users will be listed here -->
                <p class="text-gray-500">読み込み中...</p>
            </div>
        </div>

        <div id="messages" class="border border-gray-300 p-4 h-96 overflow-y-auto mb-4 rounded-md bg-gray-50 scroll-smooth">
            <!-- Messages will be displayed here -->
        </div>

        <div class="flex justify-between items-center mb-4">
            <button id="clearChatBtn" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 transition-colors duration-200 shadow-md text-sm">
                チャットをクリア
            </button>
            <div class="flex gap-2">
                <button id="toggleNotificationBtn" class="px-4 py-2 bg-purple-500 text-white font-semibold rounded-md hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-400 transition-colors duration-200 shadow-md text-sm">
                    通知ON
                </button>
                <button id="toggleDarkModeBtn" class="px-4 py-2 bg-gray-700 text-white font-semibold rounded-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-600 transition-colors duration-200 shadow-md text-sm">
                    ダークモード
                </button>
                <button id="helpBtn" class="px-4 py-2 bg-gray-500 text-white font-semibold rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 transition-colors duration-200 shadow-md text-sm">
                    ヘルプ
                </button>
            </div>
        </div>

        <div id="message-input-container" class="relative flex gap-3">
            <input type="text" id="messageInput" placeholder="メモを入力..."
                   class="flex-grow p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
            <div id="mention-autocomplete" class="hidden"></div> <!-- Mention autocomplete -->
            <button id="sendMessageBtn"
                    class="px-5 py-3 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-colors duration-200 shadow-md">
                送信
            </button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, getDocs, writeBatch, doc, setDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        // Firebase 設定 - ユーザーから提供された設定を使用
        const firebaseConfig = {
            apiKey: "AIzaSyDggfvHZMmox-_2N8lT9UjzmJTH36jSNy0",
            authDomain: "loiloidiot-mail.firebaseapp.com",
            projectId: "loiloidiot-mail",
            storageBucket: "loiloidiot-mail.firebasestorage.app",
            messagingSenderId: "457273591838",
            appId: "1:457273591838:web:5c30edaf7a908061f9860f",
            measurementId: "G-QX07FG8730"
        };

        // アプリケーションID (Canvas環境から提供されるグローバル変数)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Firebase 初期化
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // DOM要素の取得
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const clearChatBtn = document.getElementById('clearChatBtn');
        const appContainer = document.getElementById('app-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        const loadingMessage = document.getElementById('loading-message'); // 新しい要素
        const userIdDisplay = document.getElementById('user-id-display');
        const userInfoDiv = document.getElementById('user-info');
        const nicknameInput = document.getElementById('nicknameInput');
        const setNicknameBtn = document.getElementById('setNicknameBtn');
        const currentNicknameDisplay = document.querySelector('#currentNicknameDisplay span');
        const onlineUsersList = document.getElementById('onlineUsersList');
        const toggleNotificationBtn = document.getElementById('toggleNotificationBtn');
        const toggleDarkModeBtn = document.getElementById('toggleDarkModeBtn');
        const helpBtn = document.getElementById('helpBtn');
        const mentionAutocomplete = document.getElementById('mention-autocomplete');

        // NGワードリスト
        const ngWords = ['vpn', 'プロキシ', '脱出', '監視', '管理者', 'proxy', 'escape', 'monitor', 'admin'];
        const ngWordReplacement = '�';

        let userNickname = localStorage.getItem('userNickname');
        let currentUserId = null;
        let notificationEnabled = localStorage.getItem('notificationEnabled') === 'true';
        let darkModeEnabled = localStorage.getItem('darkModeEnabled') === 'true';
        let onlineUsers = {}; // { userId: nickname }
        let allKnownNicknames = new Set();

        // --- ローディングアニメーションメッセージ ---
        const loadingMessages = [
            "Initializing secure connection...",
            "Authenticating anonymous user...",
            "Fetching real-time data...",
            "Synchronizing chat history...",
            "Establishing peer-to-peer link...",
            "Encrypting data streams...",
            "Optimizing network protocols...",
            "Preparing user interface...",
            "Ready for communication."
        ];
        let loadingMessageIndex = 0;
        let loadingInterval;

        function startLoadingAnimation() {
            loadingIndicator.style.display = 'block';
            loadingMessageIndex = 0;
            loadingMessage.textContent = loadingMessages[loadingMessageIndex]; // 初回メッセージを設定
            loadingInterval = setInterval(() => {
                loadingMessageIndex = (loadingMessageIndex + 1) % loadingMessages.length;
                loadingMessage.textContent = loadingMessages[loadingMessageIndex];
            }, 1500); // 1.5秒ごとにメッセージを変更
        }

        function stopLoadingAnimation() {
            loadingIndicator.style.display = 'none';
            clearInterval(loadingInterval);
        }

        // --- ダークモードの初期設定 ---
        if (darkModeEnabled) {
            document.body.classList.add('dark-mode');
            toggleDarkModeBtn.textContent = 'ライトモード';
        } else {
            document.body.classList.remove('dark-mode');
            toggleDarkModeBtn.textContent = 'ダークモード';
        }

        // --- ニックネーム関連 ---
        const generateAnonymousNickname = () => {
            const adjectives = ['静かな', '素早い', '賢い', '秘密の', '勇敢な', '自由な', '静寂の', '輝く', '見えない', '未来の'];
            const nouns = ['学習者', '探究者', '思索家', '記録者', '開拓者', '観察者', '案内人', '伝達者', '収集家', '知識人'];
            const randomAdjective = adjectives[Math.floor(Math.random() * adjectives.length)];
            const randomNoun = nouns[Math.floor(Math.random() * nouns.length)];
            const randomNumber = Math.floor(Math.random() * 900) + 100;
            return `${randomAdjective}${randomNoun}${randomNumber}`;
        };

        if (!userNickname) {
            userNickname = generateAnonymousNickname();
            localStorage.setItem('userNickname', userNickname);
        }
        nicknameInput.value = userNickname;
        currentNicknameDisplay.textContent = userNickname;

        setNicknameBtn.addEventListener('click', () => {
            const newNickname = nicknameInput.value.trim();
            if (newNickname) {
                userNickname = newNickname;
                localStorage.setItem('userNickname', userNickname);
                currentNicknameDisplay.textContent = userNickname;
                displayMessageBox(`ニックネームを「${userNickname}」に設定しました。`, "ニックネーム設定", "blue");
                if (currentUserId) {
                    updateUserOnlineStatus(currentUserId, userNickname);
                }
            } else {
                displayMessageBox("ニックネームを入力してください。", "エラー", "red");
            }
        });

        // --- 認証とFirestoreの初期化 ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                userIdDisplay.textContent = currentUserId;
                userInfoDiv.classList.remove('hidden');
                stopLoadingAnimation(); // 認証成功でローディング停止
                console.log("認証成功！ユーザーID:", currentUserId);

                updateUserOnlineStatus(currentUserId, userNickname);
                setInterval(() => updateUserOnlineStatus(currentUserId, userNickname), 30 * 1000);

                const messagesCollectionRef = collection(db, `artifacts/${appId}/public/data/messages`);
                const q = query(messagesCollectionRef, orderBy('timestamp', 'asc'));

                onSnapshot(q, async (snapshot) => {
                    snapshot.docChanges().forEach(async (change) => {
                        if (change.type === "added") {
                            const message = change.doc.data();
                            const messageId = change.doc.id;
                            
                            if (currentUserId && message.senderId !== currentUserId && (!message.readBy || !message.readBy.includes(currentUserId))) {
                                try {
                                    await updateDoc(doc(db, `artifacts/${appId}/public/data/messages`, messageId), {
                                        readBy: arrayUnion(currentUserId)
                                    });
                                } catch (error) {
                                    console.error("Error updating read status:", error);
                                }
                            }

                            allKnownNicknames.add(message.author);

                            const messageElement = document.createElement('div');
                            messageElement.classList.add('message', 'mb-2', 'p-3', 'rounded-lg', 'break-words', 'relative', 'overflow-hidden');
                            messageElement.classList.add('bg-blue-100', 'text-blue-800', 'shadow-sm', 'message-enter');
                            messageElement.dataset.docId = messageId;

                            const timestamp = message.timestamp ? message.timestamp.toDate().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }) : '送信中...';
                            
                            let processedText = message.text;
                            ngWords.forEach(word => {
                                const regex = new RegExp(`\\b${word}\\b`, 'gi');
                                processedText = processedText.replace(regex, ngWordReplacement.repeat(word.length));
                            });

                            const mentionRegex = /@([^\s]+)/g;
                            processedText = processedText.replace(mentionRegex, (match, mentionedNickname) => {
                                if (allKnownNicknames.has(mentionedNickname)) {
                                    return `<span class="mention-highlight">@${mentionedNickname}</span>`;
                                }
                                return match;
                            });

                            const readCount = (message.readBy ? message.readBy.length : 0) - (message.senderId === currentUserId ? 1 : 0);
                            const readStatus = readCount > 0 ? `既読 ${readCount}` : '';

                            messageElement.innerHTML = `
                                <div class="font-semibold text-blue-700">${message.author}</div>
                                <div class="text-gray-900">${processedText}</div>
                                <div class="text-xs text-gray-500 mt-1 text-right">
                                    ${timestamp} ${readStatus ? `<span class="ml-2 text-gray-600">${readStatus}</span>` : ''}
                                </div>
                            `;
                            messagesDiv.appendChild(messageElement);

                            setTimeout(() => messageElement.classList.add('message-enter-active'), 10);
                            messagesDiv.scrollTop = messagesDiv.scrollHeight;

                            if (document.hidden) {
                                const isMentioned = message.mentions && message.mentions.includes(currentUserId);
                                if (notificationEnabled || isMentioned) {
                                    if (Notification.permission === "granted") {
                                        new Notification(`${message.author}からのメッセージ`, {
                                            body: message.text,
                                            icon: 'https://placehold.co/48x48/007bff/ffffff?text=M' // 仮のアイコン
                                        });
                                    } else if (Notification.permission !== "denied") {
                                        Notification.requestPermission().then(permission => {
                                            if (permission === "granted") {
                                                new Notification(`${message.author}からのメッセージ`, {
                                                    body: message.text,
                                                    icon: 'https://placehold.co/48x48/007bff/ffffff?text=M'
                                                });
                                            }
                                        });
                                    }
                                }
                            }

                        } else if (change.type === "removed") {
                            const removedMessageId = change.doc.id;
                            const messageElements = messagesDiv.children;
                            for (let i = 0; i < messageElements.length; i++) {
                                if (messageElements[i].dataset.docId === removedMessageId) {
                                    messagesDiv.removeChild(messageElements[i]);
                                    break;
                                }
                            }
                        } else if (change.type === "modified") {
                            const modifiedMessage = change.doc.data();
                            const modifiedMessageId = change.doc.id;
                            const messageElement = messagesDiv.querySelector(`[data-doc-id="${modifiedMessageId}"]`);
                            if (messageElement) {
                                const timestamp = modifiedMessage.timestamp ? modifiedMessage.timestamp.toDate().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }) : '送信中...';
                                
                                let processedText = modifiedMessage.text;
                                ngWords.forEach(word => {
                                    const regex = new RegExp(`\\b${word}\\b`, 'gi');
                                    processedText = processedText.replace(regex, ngWordReplacement.repeat(word.length));
                                });
                                const mentionRegex = /@([^\s]+)/g;
                                processedText = processedText.replace(mentionRegex, (match, mentionedNickname) => {
                                    if (allKnownNicknames.has(mentionedNickname)) {
                                        return `<span class="mention-highlight">@${mentionedNickname}</span>`;
                                    }
                                    return match;
                                });

                                const readCount = (modifiedMessage.readBy ? modifiedMessage.readBy.length : 0) - (modifiedMessage.senderId === currentUserId ? 1 : 0);
                                const readStatus = readCount > 0 ? `既読 ${readCount}` : '';

                                messageElement.innerHTML = `
                                    <div class="font-semibold text-blue-700">${modifiedMessage.author}</div>
                                    <div class="text-gray-900">${processedText}</div>
                                    <div class="text-xs text-gray-500 mt-1 text-right">
                                        ${timestamp} ${readStatus ? `<span class="ml-2 text-gray-600">${readStatus}</span>` : ''}
                                    </div>
                                `;
                            }
                        }
                    });
                }, (error) => {
                    console.error("Error getting real-time updates: ", error);
                    displayMessageBox("メッセージの取得中にエラーが発生しました。", "エラー", "red");
                });

                const usersCollectionRef = collection(db, `artifacts/${appId}/public/data/users`);
                const usersQuery = query(usersCollectionRef, orderBy('lastSeen', 'desc'));

                onSnapshot(usersQuery, (snapshot) => {
                    onlineUsers = {};
                    onlineUsersList.innerHTML = '';
                    const now = Date.now();
                    const onlineThreshold = 60 * 1000;

                    let hasOnlineUsers = false;
                    snapshot.forEach(doc => {
                        const userData = doc.data();
                        if (userData.lastSeen && (now - userData.lastSeen.toDate().getTime() < onlineThreshold)) {
                            onlineUsers[userData.userId] = userData.nickname;
                            const userSpan = document.createElement('span');
                            userSpan.className = 'flex items-center text-gray-700';
                            userSpan.innerHTML = `${userData.nickname} <span class="online-indicator"></span>`;
                            onlineUsersList.appendChild(userSpan);
                            hasOnlineUsers = true;
                            allKnownNicknames.add(userData.nickname);
                        }
                    });

                    if (!hasOnlineUsers) {
                        onlineUsersList.innerHTML = '<p class="text-gray-500">現在オンラインのユーザーはいません。</p>';
                    }
                    console.log("オンラインユーザー:", onlineUsers);
                }, (error) => {
                    console.error("Error getting online users:", error);
                    // 権限エラーの場合、ユーザーに通知
                    if (error.code === 'permission-denied') {
                        displayMessageBox("オンラインユーザー情報の取得に権限エラーが発生しました。Firebaseのセキュリティルールを確認してください。", "エラー", "red");
                        onlineUsersList.innerHTML = '<p class="text-red-500">オンラインユーザー情報の読み込みに失敗しました。権限エラーの可能性があります。</p>'; // Visual cue for permission error
                    } else {
                        displayMessageBox("オンラインユーザーの取得中にエラーが発生しました。", "エラー", "red");
                    }
                });

            } else {
                startLoadingAnimation(); // 認証開始時にローディングアニメーションを開始
                console.log("認証試行中...");
                try {
                    await signInAnonymously(auth);
                    console.log("匿名認証を試みました。");
                } catch (error) {
                    console.error("認証に失敗しました:", error);
                    displayMessageBox("認証に失敗しました。アプリをリロードしてください。", "エラー", "red");
                    stopLoadingAnimation(); // 認証失敗でローディング停止
                }
            }
        });

        async function updateUserOnlineStatus(userId, nickname) {
            if (!userId) return;
            try {
                const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
                await setDoc(userDocRef, {
                    userId: userId,
                    nickname: nickname,
                    lastSeen: serverTimestamp()
                }, { merge: true });
            } catch (error) {
                console.error("オンライン状態の更新に失敗しました:", error);
                // 権限エラーの場合、ユーザーに通知
                if (error.code === 'permission-denied') {
                    displayMessageBox("オンライン状態の更新に権限エラーが発生しました。Firebaseのセキュリティルールを確認してください。", "エラー", "red");
                }
            }
        }

        sendMessageBtn.addEventListener('click', async () => {
            const messageText = messageInput.value.trim();
            if (messageText && currentUserId) {
                let maskedMessage = messageText;
                ngWords.forEach(word => {
                    const regex = new RegExp(`\\b${word}\\b`, 'gi');
                    maskedMessage = maskedMessage.replace(regex, ngWordReplacement.repeat(word.length));
                });

                const mentionedUserIds = [];
                const mentionRegex = /@([^\s]+)/g;
                let match;
                while ((match = mentionRegex.exec(messageText)) !== null) {
                    const mentionedNickname = match[1];
                    for (const userId in onlineUsers) {
                        if (onlineUsers[userId] === mentionedNickname) {
                            mentionedUserIds.push(userId);
                            break;
                        }
                    }
                }

                try {
                    const messagesCollectionRef = collection(db, `artifacts/${appId}/public/data/messages`);
                    await addDoc(messagesCollectionRef, {
                        author: userNickname,
                        senderId: currentUserId,
                        text: maskedMessage,
                        timestamp: serverTimestamp(),
                        readBy: [currentUserId],
                        mentions: mentionedUserIds
                    });
                    messageInput.value = '';
                    console.log("メッセージ送信成功！");
                } catch (error) {
                    console.error("Error writing document: ", error);
                    displayMessageBox("メッセージの送信に失敗しました。", "エラー", "red");
                }
            } else if (!currentUserId) {
                displayMessageBox("まだ認証が完了していません。しばらくお待ちください。", "注意", "yellow");
                console.log("認証が完了していないため、メッセージを送信できません。");
            }
        });

        clearChatBtn.addEventListener('click', () => {
            displayConfirmBox("本当にチャット履歴をすべてクリアしますか？この操作は元に戻せません。", "チャットクリアの確認", "red", async (confirmed) => {
                if (confirmed) {
                    try {
                        const messagesCollectionRef = collection(db, `artifacts/${appId}/public/data/messages`);
                        const querySnapshot = await getDocs(messagesCollectionRef);
                        
                        const batch = writeBatch(db);
                        querySnapshot.docs.forEach((d) => {
                            batch.delete(doc(db, `artifacts/${appId}/public/data/messages`, d.id));
                        });
                        await batch.commit();

                        messagesDiv.innerHTML = ''; 
                        displayMessageBox("チャット履歴がクリアされました。", "完了", "blue");
                        console.log("チャット履歴がクリアされました。");
                    } catch (error) {
                        console.error("Error clearing chat: ", error);
                        displayMessageBox("チャットのクリア中にエラーが発生しました。", "エラー", "red");
                    }
                }
            });
        });

        toggleNotificationBtn.textContent = notificationEnabled ? '通知OFF' : '通知ON';

        toggleNotificationBtn.addEventListener('click', () => {
            if (Notification.permission === "default") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        notificationEnabled = true;
                        localStorage.setItem('notificationEnabled', 'true');
                        toggleNotificationBtn.textContent = '通知OFF';
                        displayMessageBox("通知が有効になりました。", "通知設定", "blue");
                    } else {
                        notificationEnabled = false;
                        localStorage.setItem('notificationEnabled', 'false');
                        toggleNotificationBtn.textContent = '通知ON';
                        displayMessageBox("通知が拒否されました。ブラウザの設定から許可してください。", "通知設定", "red");
                    }
                });
            } else if (Notification.permission === "granted") {
                notificationEnabled = !notificationEnabled;
                localStorage.setItem('notificationEnabled', notificationEnabled.toString());
                toggleNotificationBtn.textContent = notificationEnabled ? '通知OFF' : '通知ON';
                displayMessageBox(`通知が${notificationEnabled ? '有効' : '無効'}になりました。`, "通知設定", "blue");
            } else if (Notification.permission === "denied") {
                displayMessageBox("通知が拒否されています。ブラウザの設定から許可してください。", "通知設定", "red");
            }
        });

        // --- ダークモード切り替え機能 ---
        toggleDarkModeBtn.addEventListener('click', () => {
            darkModeEnabled = !darkModeEnabled;
            localStorage.setItem('darkModeEnabled', darkModeEnabled.toString());
            if (darkModeEnabled) {
                document.body.classList.add('dark-mode');
                toggleDarkModeBtn.textContent = 'ライトモード';
            } else {
                document.body.classList.remove('dark-mode');
                toggleDarkModeBtn.textContent = 'ダークモード';
            }
        });

        // --- ヘルプ機能 ---
        helpBtn.addEventListener('click', () => {
            const helpMessage = `
                <p class="mb-2">このアプリは、学習メモ共有ツールとして設計されています。</p>
                <ul class="list-disc list-inside mb-4">
                    <li><strong>メッセージ送信:</strong> 下の入力欄にメモを入力し、「送信」ボタンをクリックします。</li>
                    <li><strong>ニックネーム設定:</strong> 上部の入力欄に好きなニックネームを入力し、「設定」ボタンをクリックします。設定しない場合は自動で匿名ニックネームが割り振られます。</li>
                    <li><strong>チャットクリア:</strong> 「チャットをクリア」ボタンで、すべてのメッセージを削除できます。（元に戻せません）</li>
                    <li><strong>メンション:</strong> メッセージ内で「@ニックネーム」と入力すると、特定のユーザーにメンションできます。メンションされたメッセージはハイライト表示されます。</li>
                    <li><strong>オンラインユーザー:</strong> 「オンラインユーザー」欄で、現在アクティブなユーザーを確認できます。</li>
                    <li><strong>既読機能:</strong> メッセージの右下に「既読 X」と表示され、メッセージを読んだユーザーの数がわかります。（送信者自身はカウントされません）</li>
                    <li><strong>通知機能:</strong> 「通知ON/OFF」ボタンで、新しいメッセージが届いた際のブラウザ通知を切り替えられます。通知OFFでもメンションされた場合は通知されます。</li>
                    <li><strong>NGワード:</strong> 特定のキーワードは自動的に「🍙」にマスクされます。</li>
                </ul>
                <p class="text-sm text-gray-600">※ このアプリは実験的なツールであり、セキュリティ上の完全な保証はありません。利用は自己責任でお願いします。</p>
            `;
            displayMessageBox(helpMessage, "使い方（ヘルプ）", "blue");
        });

        // --- その他のイベントリスナー ---
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessageBtn.click();
            }
        });

        messageInput.addEventListener('input', () => {
            const text = messageInput.value;
            const lastAtIndex = text.lastIndexOf('@');

            console.log("--- メンションオートコンプリートデバッグ ---");
            console.log("Current messageInput value:", text);
            console.log("Last '@' index:", lastAtIndex);

            if (lastAtIndex !== -1 && text.substring(lastAtIndex).includes(' ')) {
                console.log("Space detected after @, hiding autocomplete.");
                mentionAutocomplete.classList.add('hidden');
                return;
            }

            if (lastAtIndex !== -1) {
                const searchTerm = text.substring(lastAtIndex + 1);
                console.log("Search term for mention:", searchTerm);
                console.log("All known nicknames (before filter):", Array.from(allKnownNicknames)); // allKnownNicknamesの内容を確認

                const filteredNicknames = Array.from(allKnownNicknames).filter(nickname =>
                    nickname.toLowerCase().startsWith(searchTerm.toLowerCase()) && nickname !== userNickname
                );
                console.log("Filtered nicknames for autocomplete:", filteredNicknames); // フィルタリング結果を確認

                mentionAutocomplete.innerHTML = '';
                if (filteredNicknames.length > 0) {
                    filteredNicknames.forEach(nickname => {
                        const div = document.createElement('div');
                        div.textContent = nickname;
                        div.addEventListener('click', () => {
                            messageInput.value = text.substring(0, lastAtIndex) + `@${nickname} `;
                            mentionAutocomplete.classList.add('hidden');
                            messageInput.focus();
                        });
                        mentionAutocomplete.appendChild(div);
                    });
                    mentionAutocomplete.classList.remove('hidden');
                } else {
                    mentionAutocomplete.classList.add('hidden');
                }
            } else {
                mentionAutocomplete.classList.add('hidden');
            }
            console.log("--- デバッグ終了 ---");
        });

        document.addEventListener('click', (event) => {
            if (!messageInput.contains(event.target) && !mentionAutocomplete.contains(event.target)) {
                mentionAutocomplete.classList.add('hidden');
            }
        });

        // カスタムメッセージボックス表示関数 (alertの代替)
        function displayMessageBox(message, title = "通知", type = "blue") {
            const existingBox = document.getElementById('custom-message-box');
            if (existingBox) existingBox.remove();

            const box = document.createElement('div');
            box.id = 'custom-message-box';
            box.className = `fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50`;
            box.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 border-t-4 ${type === 'red' ? 'border-red-500' : type === 'yellow' ? 'border-yellow-500' : 'border-blue-500'}">
                    <h3 class="text-lg font-bold mb-3 ${type === 'red' ? 'text-red-700' : type === 'yellow' ? 'text-yellow-700' : 'text-blue-700'}">${title}</h3>
                    <div class="text-gray-700 mb-4 max-h-96 overflow-y-auto">${message}</div>
                    <button id="message-box-ok-btn" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400">OK</button>
                </div>
            `;
            document.body.appendChild(box);

            document.getElementById('message-box-ok-btn').addEventListener('click', () => {
                box.remove();
            });
        }

        // カスタム確認ボックス表示関数 (confirmの代替)
        function displayConfirmBox(message, title = "確認", type = "blue", callback) {
            const existingBox = document.getElementById('custom-confirm-box');
            if (existingBox) existingBox.remove();

            const box = document.createElement('div');
            box.id = 'custom-confirm-box';
            box.className = `fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50`;
            box.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 border-t-4 ${type === 'red' ? 'border-red-500' : type === 'yellow' ? 'border-yellow-500' : 'border-blue-500'}">
                    <h3 class="text-lg font-bold mb-3 ${type === 'red' ? 'text-red-700' : type === 'yellow' ? 'text-yellow-700' : 'text-blue-700'}">${title}</h3>
                    <p class="text-gray-700 mb-4">${message}</p>
                    <div class="flex justify-end gap-3">
                        <button id="confirm-box-cancel-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">キャンセル</button>
                        <button id="confirm-box-ok-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400">OK</button>
                    </div>
                </div>
            `;
            document.body.appendChild(box);

            document.getElementById('confirm-box-ok-btn').addEventListener('click', () => {
                box.remove();
                callback(true);
            });

            document.getElementById('confirm-box-cancel-btn').addEventListener('click', () => {
                box.remove();
                callback(false);
            });
        }
    </script>
</body>
</html>
