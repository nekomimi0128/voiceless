<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>今日の復習メモ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        /* Custom scrollbar for messages div */
        #messages::-webkit-scrollbar {
            width: 8px;
        }
        #messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        #messages::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        #messages::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Fade-in animation for messages */
        .message-enter {
            opacity: 0;
            transform: translateY(10px);
        }
        .message-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }

        /* Fake screen styling - REMOVED */
        /* #fake-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #e0e0e0;
            color: #555;
            justify-content: center;
            align-items: center;
            font-size: 2em;
            flex-direction: column;
            z-index: 1000;
            text-align: center;
        }
        #fake-screen.active {
            display: flex;
        } */
    </style>
</head>
<body>
    <div id="app-container" class="bg-white p-6 md:p-8 rounded-lg shadow-xl w-full max-w-md mx-4 sm:mx-auto border border-gray-200">
        <h1 class="text-2xl md:text-3xl font-bold text-center mb-4 text-blue-700">今日の復習メモ</h1>
        <p class="text-sm text-gray-600 text-center mb-6">※ このツールは学習内容の振り返りや疑問点の共有にご利用ください。</p>

        <div id="loading-indicator" class="text-center text-gray-500 mb-4" style="display: none;">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-2"></div>
            <p>読み込み中...</p>
        </div>

        <div id="user-info" class="text-sm text-gray-500 mb-4 hidden">
            あなたのID: <span id="user-id-display" class="font-mono text-blue-600 break-all"></span>
        </div>

        <!-- Nickname setting section -->
        <div class="mb-4 p-3 border border-gray-200 rounded-md bg-gray-50">
            <label for="nicknameInput" class="block text-sm font-medium text-gray-700 mb-2">あなたのニックネーム:</label>
            <div class="flex gap-2">
                <input type="text" id="nicknameInput" placeholder="ニックネームを入力"
                       class="flex-grow p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-400 text-sm">
                <button id="setNicknameBtn"
                        class="px-3 py-2 bg-green-500 text-white font-semibold rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400 transition-colors duration-200 shadow-sm text-sm">
                    設定
                </button>
            </div>
            <p id="currentNicknameDisplay" class="text-xs text-gray-500 mt-2">現在のニックネーム: <span class="font-bold text-gray-700"></span></p>
        </div>

        <div id="messages" class="border border-gray-300 p-4 h-96 overflow-y-auto mb-4 rounded-md bg-gray-50 scroll-smooth">
            <!-- Messages will be displayed here -->
        </div>

        <div class="flex justify-end mb-4">
            <button id="clearChatBtn" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 transition-colors duration-200 shadow-md text-sm">
                チャットをクリア
            </button>
        </div>

        <div id="message-input-container" class="flex gap-3">
            <input type="text" id="messageInput" placeholder="メモを入力..."
                   class="flex-grow p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
            <button id="sendMessageBtn"
                    class="px-5 py-3 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-colors duration-200 shadow-md">
                送信
            </button>
        </div>
    </div>

    <!-- フェイク画面 - REMOVED -->
    <!-- <div id="fake-screen" class="active:flex">
        <p class="text-4xl font-bold text-gray-700 mb-4">現在の学習状況</p>
        <p class="text-xl text-gray-600">（授業内容に関する統計データや、無害な学習アドバイスなどをここに表示）</p>
        <p class="text-sm text-gray-500 mt-8">[Ctrl + H で戻る]</p>
    </div> -->

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, getDocs, writeBatch, doc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        // Firebase 設定 - ユーザーから提供された設定を使用
        const firebaseConfig = {
            apiKey: "AIzaSyDggfvHZMmox-_2N8lT9UjzmJTH36jSNy0",
            authDomain: "loiloidiot-mail.firebaseapp.com",
            projectId: "loiloidiot-mail",
            storageBucket: "loiloidiot-mail.firebasestorage.app",
            messagingSenderId: "457273591838",
            appId: "1:457273591838:web:5c30edaf7a908061f9860f",
            measurementId: "G-QX07FG8730"
        };

        // アプリケーションID (Canvas環境から提供されるグローバル変数)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // Firebase初期化トークン (Canvas環境から提供されるグローバル変数)
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase 初期化
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // DOM要素の取得
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const clearChatBtn = document.getElementById('clearChatBtn');
        // const fakeScreen = document.getElementById('fake-screen'); // REMOVED
        const appContainer = document.getElementById('app-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        const userIdDisplay = document.getElementById('user-id-display');
        const userInfoDiv = document.getElementById('user-info');
        const nicknameInput = document.getElementById('nicknameInput');
        const setNicknameBtn = document.getElementById('setNicknameBtn');
        const currentNicknameDisplay = document.querySelector('#currentNicknameDisplay span');

        // NGワードリスト
        const ngWords = ['vpn', 'プロキシ', '脱出', '監視', '管理者', 'proxy', 'escape', 'monitor', 'admin'];
        const ngWordReplacement = '🍙';

        let userNickname = localStorage.getItem('userNickname');
        let currentUserId = null;

        const generateAnonymousNickname = () => {
            const adjectives = ['静かな', '素早い', '賢い', '秘密の', '勇敢な', '自由な', '静寂の', '輝く', '見えない', '未来の'];
            const nouns = ['学習者', '探究者', '思索家', '記録者', '開拓者', '観察者', '案内人', '伝達者', '収集家', '知識人'];
            const randomAdjective = adjectives[Math.floor(Math.random() * adjectives.length)];
            const randomNoun = nouns[Math.floor(Math.random() * nouns.length)];
            const randomNumber = Math.floor(Math.random() * 900) + 100;
            return `${randomAdjective}${randomNoun}${randomNumber}`;
        };

        // ニックネームの初期設定と表示
        if (!userNickname) {
            userNickname = generateAnonymousNickname();
            localStorage.setItem('userNickname', userNickname);
        }
        nicknameInput.value = userNickname;
        currentNicknameDisplay.textContent = userNickname;

        // ニックネーム設定ボタンのイベントリスナー
        setNicknameBtn.addEventListener('click', () => {
            const newNickname = nicknameInput.value.trim();
            if (newNickname) {
                userNickname = newNickname;
                localStorage.setItem('userNickname', userNickname);
                currentNicknameDisplay.textContent = userNickname;
                displayMessageBox(`ニックネームを「${userNickname}」に設定しました。`, "ニックネーム設定", "blue");
            } else {
                displayMessageBox("ニックネームを入力してください。", "エラー", "red");
            }
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                userIdDisplay.textContent = currentUserId;
                userInfoDiv.classList.remove('hidden');
                loadingIndicator.style.display = 'none';
                console.log("認証成功！ユーザーID:", currentUserId);

                const messagesCollectionRef = collection(db, `artifacts/${appId}/public/data/messages`);
                const q = query(messagesCollectionRef, orderBy('timestamp', 'asc'));

                onSnapshot(q, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "added") {
                            const message = change.doc.data();
                            const messageElement = document.createElement('div');
                            messageElement.classList.add('message', 'mb-2', 'p-3', 'rounded-lg', 'break-words', 'relative', 'overflow-hidden');
                            messageElement.classList.add('bg-blue-100', 'text-blue-800', 'shadow-sm', 'message-enter');

                            const timestamp = message.timestamp ? message.timestamp.toDate().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }) : '送信中...';
                            
                            messageElement.innerHTML = `
                                <div class="font-semibold text-blue-700">${message.author}</div>
                                <div class="text-gray-900">${message.text}</div>
                                <div class="text-xs text-gray-500 mt-1 text-right">${timestamp}</div>
                            `;
                            messagesDiv.appendChild(messageElement);

                            setTimeout(() => messageElement.classList.add('message-enter-active'), 10);
                            messagesDiv.scrollTop = messagesDiv.scrollHeight;
                        } else if (change.type === "removed") {
                            const removedMessageId = change.doc.id;
                            const messageElements = messagesDiv.children;
                            for (let i = 0; i < messageElements.length; i++) {
                                if (messageElements[i].dataset.docId === removedMessageId) {
                                    messagesDiv.removeChild(messageElements[i]);
                                    break;
                                }
                            }
                        }
                    });
                }, (error) => {
                    console.error("Error getting real-time updates: ", error);
                    displayMessageBox("メッセージの取得中にエラーが発生しました。", "エラー", "red");
                });

            } else {
                loadingIndicator.style.display = 'block';
                console.log("認証試行中...");
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("カスタムトークンで認証を試みました。");
                    } else {
                        await signInAnonymously(auth);
                        console.log("匿名認証を試みました。");
                    }
                } catch (error) {
                    console.error("Error during authentication: ", error);
                    displayMessageBox("認証に失敗しました。アプリをリロードしてください。", "エラー", "red");
                    loadingIndicator.style.display = 'none';
                }
            }
        });

        sendMessageBtn.addEventListener('click', async () => {
            const messageText = messageInput.value.trim();
            if (messageText && currentUserId) {
                let maskedMessage = messageText;
                ngWords.forEach(word => {
                    const regex = new RegExp(`\\b${word}\\b`, 'gi');
                    maskedMessage = maskedMessage.replace(regex, ngWordReplacement.repeat(word.length));
                });

                try {
                    const messagesCollectionRef = collection(db, `artifacts/${appId}/public/data/messages`);
                    await addDoc(messagesCollectionRef, {
                        author: userNickname,
                        text: maskedMessage,
                        timestamp: serverTimestamp()
                    });
                    messageInput.value = '';
                    console.log("メッセージ送信成功！");
                } catch (error) {
                    console.error("Error writing document: ", error);
                    displayMessageBox("メッセージの送信に失敗しました。", "エラー", "red");
                }
            } else if (!currentUserId) {
                displayMessageBox("まだ認証が完了していません。しばらくお待ちください。", "注意", "yellow");
                console.log("認証が完了していないため、メッセージを送信できません。");
            }
        });

        clearChatBtn.addEventListener('click', () => {
            displayConfirmBox("本当にチャット履歴をすべてクリアしますか？この操作は元に戻せません。", "チャットクリアの確認", "red", async (confirmed) => {
                if (confirmed) {
                    try {
                        const messagesCollectionRef = collection(db, `artifacts/${appId}/public/data/messages`);
                        const querySnapshot = await getDocs(messagesCollectionRef);
                        
                        const batch = writeBatch(db);
                        querySnapshot.docs.forEach((d) => {
                            batch.delete(doc(db, `artifacts/${appId}/public/data/messages`, d.id));
                        });
                        await batch.commit();

                        messagesDiv.innerHTML = ''; 
                        displayMessageBox("チャット履歴がクリアされました。", "完了", "blue");
                        console.log("チャット履歴がクリアされました。");
                    } catch (error) {
                        console.error("Error clearing chat: ", error);
                        displayMessageBox("チャットのクリア中にエラーが発生しました。", "エラー", "red");
                    }
                }
            });
        });

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessageBtn.click();
            }
        });

        // Ctrl+Hの機能は削除されました。
        /*
        document.addEventListener('keydown', (event) => {
            if (event.ctrlKey && event.key === 'h') {
                event.preventDefault();
                if (fakeScreen.classList.contains('active')) {
                    fakeScreen.classList.remove('active');
                    appContainer.style.display = 'block';
                } else {
                    fakeScreen.classList.add('active');
                    appContainer.style.display = 'none';
                }
            }
        });
        */

        function displayMessageBox(message, title = "通知", type = "blue") {
            const existingBox = document.getElementById('custom-message-box');
            if (existingBox) existingBox.remove();

            const box = document.createElement('div');
            box.id = 'custom-message-box';
            box.className = `fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50`;
            box.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 border-t-4 ${type === 'red' ? 'border-red-500' : type === 'yellow' ? 'border-yellow-500' : 'border-blue-500'}">
                    <h3 class="text-lg font-bold mb-3 ${type === 'red' ? 'text-red-700' : type === 'yellow' ? 'text-yellow-700' : 'text-blue-700'}">${title}</h3>
                    <p class="text-gray-700 mb-4">${message}</p>
                    <button id="message-box-ok-btn" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400">OK</button>
                </div>
            `;
            document.body.appendChild(box);

            document.getElementById('message-box-ok-btn').addEventListener('click', () => {
                box.remove();
            });
        }

        function displayConfirmBox(message, title = "確認", type = "blue", callback) {
            const existingBox = document.getElementById('custom-confirm-box');
            if (existingBox) existingBox.remove();

            const box = document.createElement('div');
            box.id = 'custom-confirm-box';
            box.className = `fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50`;
            box.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 border-t-4 ${type === 'red' ? 'border-red-500' : type === 'yellow' ? 'border-yellow-500' : 'border-blue-500'}">
                    <h3 class="text-lg font-bold mb-3 ${type === 'red' ? 'text-red-700' : type === 'yellow' ? 'text-yellow-700' : 'text-blue-700'}">${title}</h3>
                    <p class="text-gray-700 mb-4">${message}</p>
                    <div class="flex justify-end gap-3">
                        <button id="confirm-box-cancel-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">キャンセル</button>
                        <button id="confirm-box-ok-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400">OK</button>
                    </div>
                </div>
            `;
            document.body.appendChild(box);

            document.getElementById('confirm-box-ok-btn').addEventListener('click', () => {
                box.remove();
                callback(true);
            });

            document.getElementById('confirm-box-cancel-btn').addEventListener('click', () => {
                box.remove();
                callback(false);
            });
        }
    </script>
</body>
</html>
